<html>
<!----------------------------------------------------
Find Alternative
Author: mozers™
------------------------------------------------------
Description:
  Альтернативная панель поиска. Возможности:
  - поиск многострочного текста
  - поиск и использованием регулярных выражений

------------------------------------------------------
Connection:
 Set in a file .properties:
  command.name.215.*=Find Alternative
  command.215.*="$(SciteDefaultHome)\tools\Find_Alt.hta"
  command.mode.215.*=subsystem:shellexec,savebefore:no
---------------------------------------------------->
<head>
	<meta http-equiv="content-type" content="text/html; charset=windows-1251">
	<meta http-equiv=MSThemeCompatible Content=Yes>
<hta:application
	id=FindAlt
	applicationName=Find_Alternative
	icon=magnify.exe
	maximizeButton=no
	innerBorder=no
	scroll=no
	singleinstance=yes
	selection=no
	version=1.0
>
<style type="text/css">
	body,table   {font-family:MS Sans Serif; font-size:8px; background-color:threedface; margin:0;}
	td           {white-space:nowrap;}
	input,button {font-family:MS Sans Serif; font-size:8px;}
	label        {cursor: hand; white-space:nowrap;}
	textarea     {width:100%; height:98%; font-family:MS Sans Serif; font-size:8pt;}
</style>
<script language="JavaScript">
window.resizeTo(600,240);
document.title = FindAlt.applicationName.replace(/_/g,' ') + ' ' + FindAlt.version;

try {
	var SciTE=new ActiveXObject("SciTE.Helper");
} catch(e) {
	alert("Please install SciTE Helper before!");
	self.close();
}

window.moveTo(SciTE.Left+50, SciTE.Top+160);

var need_init = true;
var index = 0;
var count = 0;
var mark_style = 31;
var all_text = SciTE.GetText;
var Result_array = [];

function Pattern(text){
	var pat = '';
	for (var i=0; i < text.length; i++) {
		var code = text.charCodeAt(i);
		switch(code){
			case 13:
				pat += '\\r';
				break;
			case 10:
				pat += '\\n';
				break;
			case 9:
				pat += '\\t';
				break;
			default:
				pat += '['+String.fromCharCode(code)+']';
		}
	}
	return pat;
}

function Find_All(){
	if (need_init){
		var find_text = self.find.value;
		if (!iRegExp.checked) find_text=Pattern(find_text);
		var mode = "g";
		if (!iMatchCase.checked) mode="gi";
		re = new RegExp(find_text, mode);
		var current_pos = SciTE.LUA('editor.CurrentPos');
		var i=0;
		do{
			// match_array будет содержать вхождение $0 и все подстроки $1,$2,$3,и т.д.
			var match_array = re.exec(all_text);
			if (!match_array) {break}
			var pos = []; // начальная позиция вхождения
			pos[0] = re.lastIndex - match_array[0].length;
			if (pos[0] <= current_pos) index = i;
			// в массив результатов добавляем массив одного вхождения (match_array) и начальную позицию вхождения
				Result_array[i] = match_array.concat(pos);
			i++;
		} while (true);
		count = i; // общее кол-во вхождений
		self.result.innerText = "Find " + count + " match";
		need_init = false;
	}
}

function MarkAll(){
	Find_All();
	ClearMarks();
	for (var i=0; i < count; i++) {
		var pos_start = Result_array[i][Result_array[i].length-1];
		var len = Result_array[i][0].length;
		SciTE.LUA('EditorMarkText(' + pos_start + ',' + len + ',' + mark_style + ')');
	}
}

function ClearMarks(){
	SciTE.LUA('EditorClearMarks('+mark_style+')');
}

function FindNext(){
	Find_All();
	if (count === 0) return;
	if (iDirect[0].checked){
		index--;
	}else{
		index++;
	}
	if (index < 0) index = count-1;
	if (index > count-1) index = 0;
	var match_max = Result_array[index].length - 1;

	for (match=0; match < match_max; match++) {
		var result = Result_array[index][match];
	}
	var pos_start = Result_array[index][match_max];
	var pos_end = pos_start + Result_array[index][0].length;
	SciTE.LUA('editor:SetSel(' + pos_start + ',' + pos_end + ')');
}

function on_load(){
	var find_text = SciTE.GetSelText;
	if (find_text == ''){
		var find_text = window.clipboardData.getData('Text');
	}
	self.find.value=find_text;
	self.find.select();
	self.find.focus();
	SciTE.onTop(document.title, true);
}
</script>
<body onload="on_load()">
<table width="100%" height="100%" cellpadding="0" cellspacing="0" border="0">
	<tr height="100%">
		<td width="100%">
			<table width="100%" height="100%" cellpadding="0" cellspacing="4" border="0">
				<tr>
					<td colspan="2">Find what:
				<tr>
					<td colspan="2" height="100%"><textarea name="find" onChange="need_init=true"></textarea>
				<tr>
					<td><input id="iMatchCase" type="checkbox" onClick="need_init=true;Find_All()" hidefocus><label for=MatchCase>Match case</label><br>
						<input id="iRegExp" type="checkbox" hidefocus><label for=RegExp>Regular expression</label>
					<td><fieldset><legend>&nbsp;Direction:&nbsp;</legend>
							<input name="iDirect" id="Up" type="radio" hidefocus><label for="Up">Up</label>&nbsp;
							<input name="iDirect" id="Down" type="radio" checked hidefocus><label for="Down">Down</label>
						</fieldset>
			</table>
		<td>
			<table width="100%" height="100%" cellpadding="0" cellspacing="8" border="0">
				<tr><td><input value="Find Next" type="button" onClick="FindNext()" style="width:80px">
				<tr><td><input value="Mark all" type="button" onClick="MarkAll()" style="width:80px">
				<tr><td><input value="Clear marks" type="button" onClick="ClearMarks()" style="width:80px">
				<tr><td><input value="Cancel" type="button" onClick="self.close();" style="width:80px">
			</table>
	<tr>
		<td colspan="2">
			<table style="width:100%; border-top:1px inset;" cellpadding="0" cellspacing="0">
				<tr>
					<td><span id=result contentEditable="true">&nbsp;</span></td>
					<td align=right valign=bottom width="16px"><font style="font-family:Marlett; font-size:16px">o </font>
			</table>
</table>
</body>
</html>
